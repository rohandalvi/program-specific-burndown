<!DOCTYPE html>
<html>
<head>
    <title>Program-specific-burndown</title>

    <script type="text/javascript" src="/apps/2.0rc1/sdk.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/async/1.22/async.min.js"></script>
    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.0rc1/lib/analytics/analytics-all.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var showAssignedProgram=1,value=null,showIterationCombo=0,iterationComboValue=null,lumenize=window.parent.Rally.data.lookback.Lumenize,iterationComboField=null,iterationRecord=myMask=null,setOfStories=setOfFeatures=null;Ext.define("CustomApp",{extend:"Rally.app.App",componentCls:"app",launch:function(){Ext.state.Manager.setProvider(new Ext.state.CookieProvider({expires:new Date((new Date).getTime()+10006060247)})),app=this;var that=this;console.log("launch"),this.project=this.getContext().getProject().ObjectID;var tbName=getReleaseTimeBox(this),configs=[];configs.push({model:"Release",fetch:["Name","ObjectID","Project","ReleaseStartDate","ReleaseDate"],filters:[]}),configs.push({model:"Iteration",fetch:["Name","ObjectID","Project","StartDate","EndDate"],filters:[]}),async.map(configs,this.wsapiQuery,function(err,results){that.releases=results[0],that.iterations=results[1],showAssignedProgram&&that.createAssignedProgramCombo(),that.createIterationCombo(that.iterations)})},wsapiQuery:function(config,callback){Ext.create("Rally.data.WsapiDataStore",{autoLoad:!0,limit:"Infinity",model:config.model,fetch:config.fetch,filters:config.filters,listeners:{scope:this,load:function(store,data){callback(null,data)}}})},createAssignedProgramCombo:function(){this.assignedProgramCombo=Ext.create("Rally.ui.combobox.FieldValueComboBox",{model:"PortfolioItem/Feature",field:"AssignedProgram",stateful:!0,stateId:"assignedProgramCombo",noData:!1,listeners:{scope:this,change:function(field,eOpts){""!=value&&null!=value&&this.afterCollapse(fieldValue,value)}}}),this.add(this.assignedProgramCombo)},createIterationCombo:function(iterationRecords){iterationRecord=iterationRecords;var iterations=_.map(iterationRecords,function(rec){return{name:rec.get("Name"),objectid:rec.get("ObjectID"),startDate:new Date(Date.parse(rec.get("StartDate")))}});console.log("iterations",iterations),iterations=_.uniq(iterations,function(r){return r.name}),iterations=_.sortBy(iterations,function(rec){return rec.StartDate}).reverse();var iterationStore=Ext.create("Ext.data.Store",{fields:["name","objectid"],data:iterations}),cb=Ext.create("Ext.form.ComboBox",{fieldLabel:"Iterations",store:iterationStore,queryMode:"local",displayField:"name",valueField:"name",listeners:{scope:this,change:function(field,eOpts){console.log("field ",field," eOpts ",eOpts),iterationComboValue=eOpts,iterationComboField=field},collapse:function(field,eOpts){this.afterCollapse(field,eOpts)}}});this.add(cb)},afterCollapse:function(field,eOpts){var r=[];_.each(field.getValue().split(","),function(rn){var matching_iterations=_.filter(iterationRecord,function(r){return rn==r.get("Name")}),uniq_iterations=_.uniq(matching_iterations,function(r){return r.get("Name")});_.each(uniq_iterations,function(iteration){r.push(iteration)})}),r.length>0&&(myMask=new Ext.LoadMask(Ext.getBody(),{msg:"Please wait..."}),myMask.show(),this.selectedIterations=r,this.queryFeatures(r))},queryFeatures:function(iterations){var that=this,filter=null;showAssignedProgram&&null!=this.assignedProgramCombo.getValue()&&""!=this.assignedProgramCombo.getValue()?(console.log("assingedValue",this.assignedProgramCombo.getValue()),filter=Ext.create("Rally.data.QueryFilter",{property:"AssignedProgram",operator:"=",value:this.assignedProgramCombo.getValue()})):_.each(iterations,function(iteration,i){var f=Ext.create("Rally.data.QueryFilter",{property:"Iteration.Name",operator:"=",value:iteration.get("Name")});filter=0===i?f:filter.or(f)}),console.log("filter",""+filter);var configs=[];configs.push({model:"PortfolioItem/Feature",fetch:["ObjectID","FormattedID","UserStories"],filters:[filter],listeners:{load:function(store,features){setOfFeatures=features,console.log("# features",features.length,features),that.StartDate=that.startDate(iterations),that.start=_.min(_.pluck(iterations,function(r){return r.get("StartDate")})),isoStart=new lumenize.Time(that.start).getISOStringInTZ("America/Chicago"),console.log("isoStart1",isoStart),that.end=_.max(_.pluck(iterations,function(r){return r.get("EndDate")})),that.iterations=iterations,console.log("End date ",that.end)}}}),configs.push({model:"HierarchicalRequirement",limit:"Infinity",fetch:["Name","Iteration","ObjectID","Feature"],filters:[{property:"Iteration.Name",operator:"=",value:iterationComboValue}],listeners:{load:function(store,stories){setOfStories=stories,console.log("Iteration combo value is ",iterationComboValue),console.log("# stories ",stories.length,stories)}}}),async.map(configs,this.wsapiQuery,function(err,results){setOfFeatures=results[0],_.each(results[0],function(f){console.log("f",f.get("ObjectID"))}),console.log("# features",setOfFeatures.length,setOfFeatures),that.StartDate=that.startDate(iterations),that.start=_.min(_.pluck(iterations,function(r){return r.get("StartDate")})),isoStart=new lumenize.Time(that.start).getISOStringInTZ("America/Chicago"),console.log("isoStart1",isoStart),that.end=_.max(_.pluck(iterations,function(r){return r.get("EndDate")})),that.iterations=iterations,console.log("End date ",that.end),setOfStories=results[1];var stories=_.map(setOfStories,function(story){return{name:story.get("Name"),fid:story.get("Feature").ObjectID,objectid:story.get("ObjectID")}});console.log("stories ",stories);var features=_.map(setOfFeatures,function(feature){return{name:feature.get("Name"),fid:feature.get("ObjectID")}});console.log("features ",features);var f_oid=_.map(setOfFeatures,function(f){return f.get("ObjectID")}),s_oid=_.map(setOfStories,function(f){return f.get("Feature").ObjectID});console.log("sos ",setOfFeatures.ObjectID);var intersection=_.intersection(f_oid,s_oid);console.log("cc ",intersection),that.getStorySnapShotsForFeatures()})},getStorySnapShotsForFeatures:function(){},startDate:function(iterations){var start=_.min(_.pluck(iterations,function(r){return r.get("StartDate")}));return Rally.util.DateTime.toIsoString(start,!1)}});
                function getReleaseTimeBox(app){var timeboxScope=app.getContext().getTimeboxScope(),tbName=null;if(timeboxScope){var record=timeboxScope.getRecord();tbName=record.get("Name")}else tbName="";return tbName}
                Ext.define("Ext.ux.CheckCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.checkcombo",multiSelect:!0,allSelector:!1,noData:!1,noDataText:"No combo data",addAllSelector:!1,allSelectorHidden:!1,enableKeyEvents:!0,afterExpandCheck:!1,allText:"All",oldValue:"",listeners:{focus:function(cpt){cpt.oldValue=cpt.getValue()},keydown:function(cpt,e,eOpts){var value=cpt.getRawValue(),oldValue=cpt.oldValue;value!=oldValue&&cpt.setValue("")}},createPicker:function(){var me=this,picker,menuCls=Ext.baseCSSPrefix+"menu",opts=Ext.apply({pickerField:me,selModel:{mode:me.multiSelect?"SIMPLE":"SINGLE"},floating:!0,hidden:!0,ownerCt:me.ownerCt,cls:me.el.up("."+menuCls)?menuCls:"",store:me.store,displayField:me.displayField,focusOnToFront:!1,pageSize:me.pageSize,tpl:['<ul><tpl for=".">','<li role="option" class="'+Ext.baseCSSPrefix+'boundlist-item"><span class="x-combo-checker">&nbsp;</span> {'+me.displayField+"}</li>","</tpl></ul>"]},me.listConfig,me.defaultListConfig);return picker=me.picker=Ext.create("Ext.view.BoundList",opts),me.pageSize&&picker.pagingToolbar.on("beforechange",me.onPageChange,me),me.mon(picker,{itemclick:me.onItemClick,refresh:me.onListRefresh,scope:me}),me.mon(picker.getSelectionModel(),{beforeselect:me.onBeforeSelect,beforedeselect:me.onBeforeDeselect,selectionchange:me.onListSelectionChange,scope:me}),me.store.on("load",function(store){0==store.getTotalCount()?(me.allSelectorHidden=!0,0!=me.allSelector&&me.allSelector.setStyle("display","none"),0!=me.noData&&me.noData.setStyle("display","block")):(me.allSelectorHidden=!1,0!=me.allSelector&&me.allSelector.setStyle("display","block"),0!=me.noData&&me.noData.setStyle("display","none"))}),picker},reset:function(){var me=this;me.setValue("")},setValue:function(value){if(this.value=value,!value)return 0!=this.allSelector&&this.allSelector.removeCls("x-boundlist-selected"),this.callParent(arguments);if("string"==typeof value){var me=this,records=[],vals=value.split(",");return""==value?0!=me.allSelector&&me.allSelector.removeCls("x-boundlist-selected"):vals.length==me.store.getCount()&&0!=vals.length&&(0!=me.allSelector?me.allSelector.addCls("x-boundlist-selected"):me.afterExpandCheck=!0),Ext.each(vals,function(val){var record=me.store.getById(parseInt(val));record&&records.push(record)}),me.setValue(records)}return this.callParent(arguments)},getValue:function(){return"object"==typeof this.value?this.value.join(","):this.value},getSubmitValue:function(){return this.getValue()},expand:function(){var me=this,bodyEl,picker,collapseIf;!me.rendered||me.isExpanded||me.isDestroyed?(me.fireEvent("expand",me),me.onExpand()):(bodyEl=me.bodyEl,picker=me.getPicker(),collapseIf=me.collapseIf,picker.show(),me.isExpanded=!0,me.alignPicker(),bodyEl.addCls(me.openCls),0==me.noData&&(me.noData=picker.getEl().down(".x-boundlist-list-ct").insertHtml("beforeBegin",'<div class="x-boundlist-item" role="option">'+me.noDataText+"</div>",!0)),1==me.addAllSelector&&0==me.allSelector&&(me.allSelector=picker.getEl().down(".x-boundlist-list-ct").insertHtml("beforeBegin",'<div class="x-boundlist-item" role="option"><span class="x-combo-checker">&nbsp;</span> '+me.allText+"</div>",!0),me.allSelector.on("click",function(e){if(me.allSelector.hasCls("x-boundlist-selected"))me.allSelector.removeCls("x-boundlist-selected"),me.setValue(""),me.fireEvent("select",me,[]);else{var records=[];me.store.each(function(record){records.push(record)}),me.allSelector.addCls("x-boundlist-selected"),me.select(records),me.fireEvent("select",me,records)}}),1==me.allSelectorHidden?me.allSelector.hide():me.allSelector.show(),1==me.afterExpandCheck&&(me.allSelector.addCls("x-boundlist-selected"),me.afterExpandCheck=!1)),me.mon(Ext.getDoc(),{mousewheel:collapseIf,mousedown:collapseIf,scope:me}),Ext.EventManager.onWindowResize(me.alignPicker,me),me.fireEvent("expand",me),me.onExpand())},alignPicker:function(){var me=this,picker=me.getPicker();if(me.callParent(),1==me.addAllSelector){var height=picker.getHeight();height=parseInt(height)+20,picker.setHeight(height),picker.getEl().setStyle("height",height+"px")}},onListSelectionChange:function(list,selectedRecords){var me=this,isMulti=me.multiSelect,hasRecords=selectedRecords.length>0;!me.ignoreSelection&&me.isExpanded&&(isMulti||Ext.defer(me.collapse,1,me),(isMulti||hasRecords)&&me.setValue(selectedRecords,!1),hasRecords&&me.fireEvent("select",me,selectedRecords),me.inputEl.focus(),1==me.addAllSelector&&0!=me.allSelector&&(selectedRecords.length==me.store.getTotalCount()?me.allSelector.addCls("x-boundlist-selected"):me.allSelector.removeCls("x-boundlist-selected")))}});

            Rally.launchApp('CustomApp', {
                name:"Program-specific-burndown",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
     /* Add app styles here */
}

    </style>
</head>
<body></body>
</html>
